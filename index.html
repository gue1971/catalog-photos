<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<link rel="manifest" href="manifest.webmanifest" />

<link rel="apple-touch-icon" href="./icons/icon-192.png" />

<meta name="theme-color" content="#111111" />

<title>活躍馬募集時写真集</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --bg: #222;
    --card-bg: #111;
    --text-color: #eee;
    --accent: #0078ff;
    --zoom: 1.0;
    --gap: 2px;
  }

  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif;
    background: var(--bg);
    color: var(--text-color);
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation; 
  }

  /* ツールバー */
  .toolbar {
    position: fixed; bottom: 0; left: 0; right: 0;
    height: 54px;
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(10px);
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    align-items: center;
    padding: 0 16px; z-index: 10000;
    border-top: 1px solid rgba(255,255,255,0.15);
    transition: background 0.3s;
  }
  
  .tool-btn {
    background: none; border: none;
    color: #888; display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 10px; gap: 0; cursor: pointer;
    width: 60px; height: 100%;
  }
  .tool-btn i { font-size: 24px; margin-bottom: 0; }
  .tool-btn:active { transform: scale(0.90); color: #fff; }
  .tool-btn.search { grid-column: 2; justify-self: center; }
  .tool-btn.settings { grid-column: 3; justify-self: end; }

  /* フィルターモード用ツールバー */
  .toolbar.mode-filter {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    align-items: center;
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(10px);
    gap: 0;
  }
  .toolbar.mode-filter .tool-btn {
    color: #888;
    justify-self: center;
  }
  .toolbar.mode-filter .tool-btn:active {
    color: #fff;
  }
  .mode-filter-home { justify-self: start; }
  .mode-filter-search { justify-self: center; }
  .mode-filter-label {
    justify-self: end;
    color: #aaa;
    font-size: 13px;
    max-width: 34vw;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: right;
    padding-right: 8px;
  }
  
  .filter-status {
    color: #eee; font-size: 14px; font-weight: 600;
    display: flex; flex-direction: column; align-items: center;
    line-height: 1.2;
    flex: 1; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .filter-status span { font-size: 10px; opacity: 0.75; font-weight: 500; }
  
  .filter-btn {
    background: #2b2b2b; color: #ddd;
    border: 1px solid #444; border-radius: 20px;
    padding: 8px 16px; font-size: 13px; font-weight: bold;
    cursor: pointer; display: flex; align-items: center; gap: 6px;
    white-space: nowrap;
  }
  .filter-btn:active { transform: scale(0.95); background: #3a3a3a; }
  .filter-btn.primary {
    background: #3a3a3a; color: #eee; border: 1px solid #4a4a4a;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .viewport {
    width: 100vw;
    height: calc(100vh - 54px);
    overflow: auto; 
    position: relative;
    -webkit-overflow-scrolling: touch; 
    touch-action: manipulation;
  }

  /* --- ボードレイアウト --- */
  .board {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: calc(var(--gap) * var(--zoom));
    width: calc(100% * var(--zoom));
    padding: 8px;
    box-sizing: border-box;
    padding-bottom: 300px; 
    transform-origin: 0 0;
  }

  .board.mode-filter {
    display: flex;
    flex-wrap: wrap;
    width: 100%;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 0; 
    padding: 8px;
    padding-bottom: 400px; 
  }

  /* --- セルスタイル --- */
  .cell {
    position: relative;
    border-radius: calc(2px * var(--zoom));
    overflow: hidden;
    touch-action: manipulation;
    display: flex; flex-direction: column;
    box-sizing: border-box;
    background: #333; height: auto; 
  }

  .board.mode-filter .cell {
    width: calc( (100% / 6) * var(--zoom) - 6px );
    margin: 3px;
    max-width: 90vw; 
    border-radius: 4px;
    flex-grow: 0; flex-shrink: 0;
  }

  .cell.card {
    background: var(--card-bg);
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    border: 1px solid #444;
  }
  
  .cell.card img {
    width: 100%; height: auto; display: block; 
    pointer-events: none; aspect-ratio: 4/3; 
    object-fit: contain; background: #000;
  }
  .cell.card .placeholder-icon {
    width: 100%; aspect-ratio: 4/3; background: #000;
    display: flex; align-items: center; justify-content: center;
    color: #555; font-size: calc(24px * var(--zoom));
  }

  .cell.card .info-area {
    padding: 2px 4px;
    background: var(--card-bg);
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;     
    flex-grow: 0; min-height: 20px; transition: min-height 0.2s;
    overflow: hidden;
  }

  .info-title { 
    font-weight: bold; font-size: 11px; color: #eee; 
    line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    margin-bottom: 0; max-width: 100%;
  }
  
  .info-sub { 
    display: none; font-size: 10px; color: #aaa; 
    line-height: 1.1; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
  }
  
  .board.view-detail .cell.card .info-area,
  .board.mode-filter .cell.card .info-area {
    flex-direction: row; align-items: baseline; justify-content: center; 
    gap: 4px; flex-wrap: nowrap;
  }
  
  .board.view-detail .info-title, .board.mode-filter .info-title {
    flex-shrink: 0; min-width: auto; max-width: 100%;
  }

  .board.view-detail .info-sub, .board.mode-filter .info-sub { 
    display: inline-block; flex-shrink: 100; min-width: 0; max-width: 100%;
  }
  
  .board.view-detail .info-sub::before, .board.mode-filter .info-sub::before { content: "("; }
  .board.view-detail .info-sub::after, .board.mode-filter .info-sub::after { content: ")"; }

  .mini-check {
    display: none; width: 16px; height: 16px;
    background: #666; border-radius: 50%;
    align-items: center; justify-content: center;
    font-size: 9px; color: #000; cursor: pointer;
    margin-left: 2px; flex-shrink: 0; 
  }
  .board.mode-filter .mini-check { display: flex; }
  .mini-check.checked { background: #666; color: #fff; }
  .mini-check i { pointer-events: none; }

  @keyframes neon-pulse {
    0%, 100% { transform: scale(1.0); border-color: #444; box-shadow: none; background-color: var(--card-bg); z-index: 1; }
    50% { transform: scale(1.1); border-color: #fff; background-color: #443300; box-shadow: 0 0 50px rgba(255, 215, 0, 0.9), inset 0 0 30px rgba(255, 215, 0, 0.4); z-index: 1000; }
  }
  .cell.highlight { animation: neon-pulse 1.0s ease-in-out infinite; }

  .cell.spacer {
    background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.1);
  }
  .cell.spacer::before { content: ""; display: block; width: 100%; aspect-ratio: 4/3; }
  .cell.spacer::after { content: ""; display: block; flex-grow: 1; min-height: 20px; border-top: 1px solid rgba(255,255,255,0.05); }

  .cell.is-placeholder { opacity: 0.15; border: 1px dashed #666; filter: grayscale(100%); }
  .cell.pressed { transform: scale(0.95); transition: transform 0.1s; filter: brightness(1.2); }
  body.is-dragging { touch-action: none; overflow: hidden; }

  .ghost {
    position: fixed; z-index: 9999; width: 120px;
    border-radius: 6px; overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.8); pointer-events: none;
    background: var(--card-bg); border: 1px solid #aaa; opacity: 0.95;
    transform: translate(-50%, -110%) scale(1.1); 
  }
  .ghost img { width: 100%; aspect-ratio: 4/3; display: block; }
  .ghost .info-area { padding: 4px; background: #222; display: block; }
  .ghost .info-title { font-size: 12px; font-weight: bold; color: #fff; }
  .ghost .info-sub { display: block; font-size: 10px; color: #aaa; }

  /* モーダル共通 */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    z-index: 20000; display: none;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  #detailModal {
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  #detailModal .modal-window {
    width: min(80vw, 520px, calc((100vh - 300px) * 4 / 3));
    height: min(94vh, 800px);
    max-height: 94vh;
    border-radius: 0;
    border: 1px solid #333;
  }
  
  .modal-window {
    width: 90%; max-width: 500px; height: 80vh;
    background: #1a1a1a; border-radius: 12px;
    display: flex; flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    border: 1px solid #333; overflow: hidden;
  }
  
  .modal-header {
    padding: 16px; background: #222; border-bottom: 1px solid #333;
    display: flex; justify-content: space-between; align-items: center;
  }
  .modal-title { font-weight: bold; font-size: 16px; }
  .modal-close { background: none; border: none; color: #aaa; font-size: 24px; cursor: pointer; }
  
  .modal-tabs {
    display: flex; background: #111; border-bottom: 1px solid #333; flex-shrink: 0;
  }
  .tab-btn {
    flex: 1; padding: 12px; background: none; border: none;
    color: #666; font-size: 14px; cursor: pointer; border-bottom: 2px solid transparent;
  }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; }

  /* 管理・台帳用コントロールバー */
  .control-bar {
    background: #1e1e1e; padding: 8px 12px;
    display: flex; flex-direction: column; gap: 8px;
    border-bottom: 1px solid #333;
  }
  .ctrl-row { display: flex; gap: 8px; overflow-x: auto; }
  .ctrl-btn {
    flex: 1; padding: 6px 4px; font-size: 11px;
    background: #333; border: 1px solid #444; color: #aaa;
    border-radius: 4px; cursor: pointer; white-space: nowrap;
    text-align: center;
  }
  .ctrl-btn.active { background: #3d3d3d; color: var(--accent); border-color: var(--accent); font-weight: bold; }

  .modal-content {
    flex: 1; overflow-y: auto; padding: 0;
    -webkit-overflow-scrolling: touch;
  }
  
  .search-list { list-style: none; padding: 0; margin: 0; }
  .search-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-bottom: 1px solid #333;
    cursor: pointer;
  }
  .search-item:active { background: #2a2a2a; }
  
  .item-left { 
    display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; 
    pointer-events: none;
  }
  .item-check { 
    width: 20px; height: 20px; border-radius: 4px; border: 2px solid #555;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0; 
    pointer-events: auto; position: relative; cursor: pointer;
  }
  .item-check::before {
    content: ""; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px;
  }
  .item-check.checked { background: var(--accent); border-color: var(--accent); color: #fff; }
  .item-check.checked::after { content: "✔"; font-size: 12px; }
  
  .item-info { display: flex; flex-direction: row; align-items: baseline; gap: 8px; overflow: hidden; flex: 1; min-width: 0; }
  .item-name { font-size: 14px; font-weight: bold; color: #eee; white-space: nowrap; flex-shrink: 0; }
  .item-sub { font-size: 11px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0; }
  
  .item-jump {
    padding: 6px 12px; background: #333; border-radius: 4px;
    font-size: 11px; color: #aaa; border: 1px solid #444;
    flex-shrink: 0; margin-left: 8px;
    pointer-events: auto;
  }
  .item-jump.disabled {
    opacity: 0.35;
    filter: grayscale(100%);
    pointer-events: none;
  }

  .jump-only-item { padding: 14px 16px; font-size: 14px; color: #eee; border-bottom: 1px solid #333; cursor: pointer; }
  .jump-only-item:active { background: var(--accent); color: #fff; }
  .jump-sub { font-size: 11px; color: #888; margin-left: 8px; }

  .menu-list { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .menu-btn {
    background: #333; border: 1px solid #444; color: #eee;
    padding: 14px; border-radius: 8px; text-align: left; font-size: 14px;
    display: flex; align-items: center; gap: 12px;
  }
  .menu-btn i { width: 20px; text-align: center; color: #888; }

  .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 16px; }
  .cat-grid.single-col { grid-template-columns: 1fr; }
  .cat-btn {
    background: #252525; border: 1px solid #333; color: #ddd;
    padding: 12px; border-radius: 6px; text-align: center; font-size: 13px;
    cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
  }
  .cat-btn:active { background: #444; }
  .cat-btn.disabled { opacity: 0.3; pointer-events: none; }
  .cat-count { background: #444; padding: 2px 6px; border-radius: 10px; font-size: 11px; color: #ccc; }

  .sire-grid { padding: 16px; }
  .sire-cat-btn { text-align: left; gap: 8px; }
  .sire-item-main {
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    cursor: pointer;
  }
  .sire-head {
    width: 14px;
    flex-shrink: 0;
    color: #9a9a9a;
    font-size: 12px;
    font-weight: 700;
    text-align: center;
  }
  .sire-head.empty { opacity: 0; }
  .sire-filter-btn {
    background: #333;
    border: 1px solid #4a4a4a;
    color: #ddd;
    border-radius: 4px;
    width: 30px;
    height: 30px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    font-size: 13px;
    flex-shrink: 0;
    cursor: pointer;
  }
  .sire-filter-btn:active { background: #444; }
  .sire-name {
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .back-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 12px 16px; background: #222; border-bottom: 1px solid #333;
    color: var(--accent); font-size: 14px; cursor: pointer; font-weight: bold;
  }
  
  #fileInput { display: none; }

  /* Undo Toast */
  #undoToast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px);
    background: #333; border: 1px solid #444; color: #fff;
    padding: 12px 20px; border-radius: 24px;
    display: flex; align-items: center; gap: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 30000;
    pointer-events: none; opacity: 0;
  }
  #undoToast.show {
    transform: translateX(-50%) translateY(0);
    pointer-events: auto; opacity: 1;
  }
  #undoBtn {
    background: var(--accent); color: #fff; border: none;
    padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;
    cursor: pointer;
  }

  /* ★ V46: 詳細カードモーダル (タイポグラフィ調整) */
  .detail-card {
    padding: 0;
    display: flex; flex-direction: column;
    height: 100%; background: #151515;
    overflow: hidden;
  }
  .detail-img-box {
    width: 100%;
    aspect-ratio: 4 / 3;
    background: #000;
    position: relative; flex-shrink: 0;
  }
  .detail-img-box img {
    width: 100%; height: 100%; object-fit: cover;
  }
  .detail-header {
    padding: 10px 16px; border-bottom: 1px solid #333;
    background: #222;
  }
  .detail-title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  
  /* ★ V46: ベースライン揃え */
  .detail-name { 
    font-size: 18px; font-weight: bold; margin-bottom: 4px; color: #fff; 
    display: flex; align-items: baseline; 
    min-width: 0;
    overflow: hidden;
  }
  /* ★ V46: 性別は装飾なし、12px、間隔あり */
  .name-sex {
    font-size: 12px; font-weight: normal; color: #aaa; margin-left: 8px;
  }
  .detail-close-inline {
    background: none;
    border: none;
    color: #bbb;
    font-size: 30px;
    line-height: 1;
    cursor: pointer;
    flex-shrink: 0;
    padding: 0;
    margin-right: -4px;
  }
  .detail-close-inline:active { color: #fff; }
  
  .detail-sub { font-size: 13px; color: #eee; line-height: 1.35; }
  .pedigree-row { margin-bottom: 2px; }
  .p-label { color: #888; font-size: 12px; margin-right: 4px; }
  .p-spacer { display: inline-block; width: 16px; } 
  
  .detail-body {
    flex: 1; min-height: 0; overflow-y: auto; padding: 10px 16px 8px;
  }
  .detail-table {
    width: 100%; border-collapse: collapse; font-size: 13px;
  }
  .detail-table th, .detail-table td {
    padding: 6px 0; border-bottom: 1px solid #333;
  }
  .detail-table th { width: 30%; color: #888; font-weight: normal; text-align: left; }
  .detail-table td { width: 70%; color: #eee; font-weight: 500; text-align: right; }
  
  .detail-actions {
    padding: 10px 12px; background: #222; border-top: 1px solid #333;
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
    flex-shrink: 0;
  }
  .action-btn {
    background: #333; border: 1px solid #444; color: #eee;
    border-radius: 8px; padding: 8px 0;
    display: flex; flex-direction: column; align-items: center; gap: 6px;
    font-size: 10px; cursor: pointer; text-decoration: none;
  }
  .action-btn i { font-size: 16px; color: #aaa; }
  .action-btn:active { background: #444; }
  
  .action-btn.netkeiba i { color: #3755a5; }

  .action-btn.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(100%); }
  .action-btn.movie i { color: #f44336; }
  .action-btn.pdf i { color: #4caf50; }

  @media (max-width: 768px) {
    #detailModal {
      align-items: center;
      justify-content: center;
    }
    #detailModal .modal-window {
      height: auto;
      max-height: none;
    }
    .detail-card {
      height: auto;
    }
    .detail-header {
      padding: 8px 12px;
    }
    .detail-body {
      flex: 0 0 auto;
      max-height: none;
      overflow: visible;
      padding: 8px 12px 4px;
    }
    .detail-table th,
    .detail-table td {
      padding: 4px 0;
    }
    .detail-actions {
      padding: 8px 10px;
      gap: 6px;
    }
  }

</style>

</head>
<body>

<div class="viewport" id="viewport">
  <div id="board" class="board"></div>
</div>

<div id="toolbar" class="toolbar"></div>

<div id="undoToast">
  <span>変更しました</span>
  <button id="undoBtn" onclick="app.execUndo()">元に戻す</button>
</div>

<div id="searchModal" class="modal-overlay">
  <div class="modal-window">
    <div class="modal-header">
      <div class="modal-title">馬を検索・管理</div>
      <button class="modal-close" onclick="app.closeModal('searchModal')">×</button>
    </div>
    <div class="modal-tabs">
      <button class="tab-btn active" onclick="app.switchTab('sire')">種牡馬</button>
      <button class="tab-btn" onclick="app.switchTab('kana')">50音順</button>
      <button class="tab-btn" onclick="app.switchTab('all')">全頭リスト</button>
    </div>
    <div class="modal-content" id="searchContent"></div>
  </div>
</div>

<div id="detailModal" class="modal-overlay">
  <div class="modal-window">
    <div class="detail-card">
      <div class="detail-img-box">
        <img id="detailImg" src="" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgNzUiIGZpbGw9IiMzMzMiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzU1NSIgZm9udC1zaXplPSIxMCI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'">
      </div>
      <div class="detail-header">
        <div class="detail-title-row">
          <div class="detail-name" id="detailName"></div>
          <button class="detail-close-inline" onclick="app.closeModal('detailModal')">×</button>
        </div>
        <div class="detail-sub" id="detailSub">
          </div>
      </div>
      <div class="detail-body">
        <table class="detail-table" id="detailTable"></table>
      </div>
      <div class="detail-actions">
        <a id="btnNetkeiba" class="action-btn netkeiba" target="_blank">
          <i class="fa-solid fa-horse-head"></i>
          <span>netkeiba</span>
        </a>
        <a id="btnPdf" class="action-btn pdf disabled" target="_blank">
          <i class="fa-solid fa-file-pdf"></i>
          <span>カタログ</span>
        </a>
        <a id="btnMovie" class="action-btn movie disabled" target="_blank">
          <i class="fa-brands fa-youtube"></i>
          <span>募集動画</span>
        </a>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal-overlay">
  <div class="modal-window" style="height: auto;">
    <div class="modal-header">
      <div class="modal-title">設定・データ</div>
      <button class="modal-close" onclick="app.closeModal('settingsModal')">×</button>
    </div>
    <div class="menu-list">
      <div style="font-size:12px; color:#666; margin-bottom:8px;">
        ズーム: <span id="zoomDisp">100%</span>
      </div>
      <div style="font-size:11px; color:#888; margin-bottom:4px;">
        ※ 全馬データ（all-horses.json）は変更されません
      </div>
      <button class="menu-btn" onclick="app.exportData()">
        <i class="fa-solid fa-upload"></i> 表示状態をエクスポート (JSON)
      </button>
      <button class="menu-btn" onclick="app.openImportPicker()">
        <i class="fa-solid fa-download"></i> 表示状態をインポート
      </button>
      <button class="menu-btn" onclick="app.resetData()" style="color:#f55; border-color:#533;">
        <i class="fa-solid fa-table-cells-large"></i> 登録馬を全て表示
      </button>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept=".json" onchange="app.importData(this)">

<script>
/**
 * Horse Board Logic (V46: Polished Header 2)
 * - Header Name: Name + Sex(small, no parens) aligned baseline.
 */

const CONFIG = {
  columnCount: 9, 
  minZoom: 1.0,
  maxZoom: 12.0, 
  detailThreshold: 2.0, 
  storageKey: "horse_board_v23_db",
  
  longPressDelay: 300, 
  moveThreshold: 10
};

const state = {
  masterData: [], 
  mySelectionIds: [], 
  viewMode: 'my', 
  filterType: null, 
  filterValue: null,
  zoom: 1.0,
  renderItems: [],
  activeTab: 'sire',
  kanaNav: { level: 0, rowKey: null, char: null },
  sireNav: { level: 0, sire: null },
  listFilter: 'all', 
  listSort: 'id',
  lastOp: null, 
  undoTimer: null
};

const KANA_MAP = {
  "ア行": ["ア","イ","ウ","エ","オ"],
  "カ行": ["カ","キ","ク","ケ","コ"],
  "サ行": ["サ","シ","ス","セ","ソ"],
  "タ行": ["タ","チ","ツ","テ","ト"],
  "ナ行": ["ナ","ニ","ヌ","ネ","ノ"],
  "ハ行": ["ハ","ヒ","フ","ヘ","ホ"],
  "マ行": ["マ","ミ","ム","メ","モ"],
  "ヤ行": ["ヤ","ユ","ヨ"],
  "ラ行": ["ラ","リ","ル","レ","ロ"],
  "ワ行": ["ワ","ヲ","ン"]
};

// クラブ名正式名称
const CLUB_MAP = {
  "インゼル": "インゼルサラブレッドクラブ",
  "ウイン": "ウインレーシングクラブ",
  "キャロット": "キャロットクラブ",
  "サンデー": "サンデーサラブレッドクラブ",
  "社台": "社台サラブレッドクラブ",
  "シルク": "シルクホースクラブ",
  "G1": "Ｇ１サラブレッドクラブ",
  "ＤＭＭ": "ＤＭＭバヌーシー",
  "DMM": "ＤＭＭバヌーシー",
  "東京": "東京サラブレッドクラブ",
  "ノルマンディー": "ノルマンディーオーナーズクラブ",
  "広尾": "広尾サラブレッド倶楽部",
  "ユニオン": "ユニオンオーナーズクラブ",
  "ライオン": "サラブレッドクラブライオン",
  "ラフィアン": "ラフィアンターフマンクラブ",
  "ロード": "ロードサラブレッドオーナーズ",
  "ターファイト": "ターファイトクラブ", 
  "ローレル": "ローレルクラブ"
};

function generateUniqueKey() { return `obj_${Date.now()}_${state.nextId++}`; }

const app = {
  async init() {
    try {
      this.board = document.getElementById("board");
      this.viewport = document.getElementById("viewport");
      this.toolbar = document.getElementById("toolbar");
      this.zoomDisp = document.getElementById("zoomDisp");
      this.undoToast = document.getElementById("undoToast");
      
      await this.loadMasterData();
      await this.loadUserState();
      
      this.updateRenderItems();
      this.updateUIState();
      this.render();
      this.updateZoomStyle();
      this.attachEvents();
    } catch(e) {
      alert("初期化エラー: " + e);
    }
  },

  async loadMasterData() {
    try {
      const res = await fetch(`data/all-horses.json?t=${Date.now()}`);
      if (res.ok) state.masterData = await res.json();
    } catch (e) { state.masterData = []; }
  },

  async loadUserState() {
    let selectedFileState = null;
    try {
      const res = await fetch(`data/selected.json?t=${Date.now()}`);
      if (res.ok) selectedFileState = await res.json();
    } catch (e) {}

    if (selectedFileState && Array.isArray(selectedFileState.mySelectionIds)) {
      state.mySelectionIds = selectedFileState.mySelectionIds;
      state.zoom = selectedFileState.zoom || 1.0;
      this.saveUserState();
      return;
    }

    const raw = localStorage.getItem(CONFIG.storageKey);
    if (raw) {
      try {
        const saved = JSON.parse(raw);
        state.mySelectionIds = saved.mySelectionIds || [];
        state.zoom = saved.zoom || 1.0;
      } catch(e) { console.error(e); }
    } else {
      state.mySelectionIds = state.masterData.map(h => h.id);
    }
  },

  saveUserState() {
    const data = { mySelectionIds: state.mySelectionIds, zoom: state.zoom };
    localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
  },

  updateRenderItems() {
    let items = [];
    
    if (state.viewMode === 'my') {
      state.mySelectionIds.forEach(id => {
        const horse = state.masterData.find(h => String(h.id) === String(id));
        if (horse) items.push({ ...horse, type: 'card' });
      });
    } else if (state.viewMode === 'filter') {
      if (state.filterType === 'sire') {
        const targetSire = state.filterValue; 
        items = state.masterData
          .filter(h => h.sire && h.sire.trim() === targetSire)
          .map(h => ({ ...h, type: 'card' }));
      } 
      items.sort((a,b) => String(b.id).localeCompare(String(a.id))); 
    }
    state.renderItems = items;
  },

  render() {
    this.board.innerHTML = "";
    const displayList = [...state.renderItems];
    
    if (state.viewMode === 'my') {
        this.board.classList.remove('mode-filter');
        const remainder = displayList.length % CONFIG.columnCount;
        if (remainder !== 0) {
          const needed = CONFIG.columnCount - remainder;
          for (let i = 0; i < needed; i++) displayList.push({ type: 'spacer' });
        }
        if (displayList.length === 0) {
           for (let i = 0; i < CONFIG.columnCount; i++) displayList.push({ type: 'spacer' });
        }
    } else {
        this.board.classList.add('mode-filter');
    }

    const fragment = document.createDocumentFragment();
    displayList.forEach((item, index) => {
      const cell = this.createCell(item, index);
      fragment.appendChild(cell);
    });
    this.board.appendChild(fragment);
  },

  createCell(item, index) {
    const el = document.createElement("div");
    el.className = `cell ${item.type}`;
    el.dataset.index = index;
    el.dataset.type = item.type;
    
    if (item.type === 'card') {
      el.dataset.horseId = item.id;
      const imgPath = `assets/images/${item.id}.jpeg`;
      const sireName = item.sire || "不明";
      
      const isSelected = this.isSelected(item.id);
      
      el.innerHTML = `
        <img src="${imgPath}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
        <div class="placeholder-icon" style="display:none"><i class="fa-solid fa-horse-head"></i></div>
        <div class="info-area">
          <div class="info-title">${item.name}</div>
          <div class="info-sub">${sireName}</div>
          <div class="mini-check ${isSelected ? 'checked' : ''}" onclick="app.toggleSelectionOnCard('${item.id}', this, event)">
            <i class="fa-solid fa-check"></i>
          </div>
        </div>
      `;
    }
    return el;
  },
  
  // ★ V46: 詳細表示ロジック（スッキリ配置 2）
  showDetail(cell) {
    cell.classList.add("pressed");
    setTimeout(()=> cell.classList.remove("pressed"), 200);
    
    const horseId = cell.dataset.horseId;
    this.showDetailById(horseId);
  },

  showDetailById(horseId) {
    const horse = state.masterData.find(h => String(h.id) === String(horseId));
    if (!horse) return;

    // 画像
    document.getElementById('detailImg').src = `assets/images/${horse.id}.jpeg`;
    
    const d = horse.detail || {};
    let motherName = d['募集馬名'] || '';
    motherName = motherName.replace(/の\d+$/, '');
    const sireName = horse.sire || '-';
    const damSire = d['dam_sire'] || '-';
    const sex = d['sex'] || '';
    
    // ★ ヘッダー: 馬名 + 性別 (カッコなし、小文字)
    const nameArea = document.getElementById('detailName');
    nameArea.innerHTML = `${horse.name}<span class="name-sex">${sex}</span>`;
    
    // ヘッダー2: 血統 (父・母 横並び / 母父 その下)
    const subArea = document.getElementById('detailSub');
    subArea.innerHTML = `
      <div class="pedigree-row">
        <span class="p-label">父</span> ${sireName}
        <span class="p-spacer"></span>
        <span class="p-label">母</span> ${motherName}
      </div>
      <div class="pedigree-row">
        <span class="p-label">母父</span> ${damSire}
      </div>
    `;
    
    // データ処理
    const rawClub = d['club'] || '';
    const fullClub = CLUB_MAP[rawClub] || rawClub;
    
    const birthYear = String(horse.id).substring(0, 4);
    const birthDate = d['birthday'] || '';
    const fullBirthday = birthDate ? `${birthYear}/${birthDate}` : '';
    
    const h = d['体高'], c = d['胸囲'], t = d['管囲'];
    let measureStr = "";
    if (h) measureStr += `体高 ${h} / `;
    if (c) measureStr += `胸囲 ${c} / `;
    if (t) measureStr += `管囲 ${t}`;
    if (measureStr.endsWith(' / ')) measureStr = measureStr.slice(0, -3);
    
    const table = document.getElementById('detailTable');
    const fields = [
      { k: 'クラブ', v: fullClub },
      { k: '募集価格', v: d['price'] ? d['price'] + '万円' : null },
      { k: '厩舎', v: d['stable'] },
      { k: '生年月日', v: fullBirthday },
      { k: '測尺', v: measureStr },
      { k: '馬体重', v: d['馬体重'] ? d['馬体重'] + 'kg' : null }
    ];
    
    table.innerHTML = fields
      .filter(f => f.v)
      .map(f => `<tr><th>${f.k}</th><td>${f.v}</td></tr>`)
      .join('');

    // ボタン
    const btnNet = document.getElementById('btnNetkeiba');
    const btnMov = document.getElementById('btnMovie');
    const btnPdf = document.getElementById('btnPdf');
    
    btnNet.href = `https://db.netkeiba.com/horse/${horse.id}`;
    
    if (horse.link_movie) {
      btnMov.href = horse.link_movie;
      btnMov.classList.remove('disabled');
    } else {
      btnMov.removeAttribute('href');
      btnMov.classList.add('disabled');
    }
    
    if (horse.link_pdf) {
      btnPdf.href = horse.link_pdf;
      btnPdf.classList.remove('disabled');
    } else {
      btnPdf.removeAttribute('href');
      btnPdf.classList.add('disabled');
    }

    document.getElementById('detailModal').classList.add('open');
  },
  
  toggleSelectionOnCard(id, btnEl, e) {
    e.stopPropagation(); 
    const idx = state.mySelectionIds.findIndex(sid => String(sid) === String(id));
    if (idx >= 0) {
        state.mySelectionIds.splice(idx, 1);
        btnEl.classList.remove('checked');
    } else {
        state.mySelectionIds.push(id);
        btnEl.classList.add('checked');
    }
    this.saveUserState();
  },

  updateZoomStyle() {
    if (!state.zoom || isNaN(state.zoom)) state.zoom = 1.0;
    document.documentElement.style.setProperty('--zoom', state.zoom);
    if(this.zoomDisp) this.zoomDisp.textContent = Math.round(state.zoom * 100) + "%";
    
    if (state.zoom >= CONFIG.detailThreshold) {
      this.board.classList.add("view-detail");
    } else {
      this.board.classList.remove("view-detail");
    }
  },

  isSelected(id) {
    return state.mySelectionIds.some((sid) => String(sid) === String(id));
  },
  
  updateUIState() {
    if (state.viewMode === 'my') {
      this.toolbar.classList.remove('mode-filter');
      this.toolbar.innerHTML = `
        <button class="tool-btn search" onclick="app.openSearchModal()">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
        <button class="tool-btn settings" onclick="app.openSettingsModal()">
          <i class="fa-solid fa-gear"></i>
        </button>
      `;
    } else {
      this.toolbar.classList.add('mode-filter');
      this.toolbar.innerHTML = `
        <button class="tool-btn mode-filter-home" onclick="app.resetView()">
          <i class="fa-solid fa-house"></i>
        </button>
        <button class="tool-btn mode-filter-search" onclick="app.openSearchModal()">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
        <div class="mode-filter-label">${state.filterType === 'sire' ? state.filterValue : (state.filterValue || '')}</div>
      `;
    }
  },

  openSearchModal() {
    document.getElementById('searchModal').classList.add('open');
    this.switchTab(state.activeTab); 
  },
  openSettingsModal() {
    document.getElementById('settingsModal').classList.add('open');
  },
  closeModal(id) {
    document.getElementById(id).classList.remove('open');
    if (state.viewMode === 'my') {
      this.updateRenderItems();
      this.render();
    }
  },

  handleSearchModalBackdropTap() {
    if (state.activeTab === 'sire') {
      if (state.sireNav && state.sireNav.level >= 1) {
        const container = document.getElementById('searchContent');
        if (container) this.renderSireTab(container);
        else this.closeModal('searchModal');
        return;
      }
      this.closeModal('searchModal');
      return;
    }

    if (state.activeTab !== 'kana' || !state.kanaNav) {
      this.closeModal('searchModal');
      return;
    }
    const container = document.getElementById('searchContent');
    if (!container) {
      this.closeModal('searchModal');
      return;
    }
    if (state.kanaNav.level >= 2 && state.kanaNav.rowKey) {
      this.renderKanaSub(container, state.kanaNav.rowKey);
      return;
    }
    if (state.kanaNav.level === 1) {
      this.renderKanaRows(container);
      return;
    }
    this.closeModal('searchModal');
  },
  
  switchTab(tab) {
    state.activeTab = tab; 
    
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(t => t.classList.remove('active'));
    
    if(tab === 'sire') tabs[0].classList.add('active');
    if(tab === 'kana') tabs[1].classList.add('active');
    if(tab === 'all')  tabs[2].classList.add('active');
    
    const container = document.getElementById('searchContent');
    container.innerHTML = "";
    
    if (tab === 'all') {
      this.renderAllTab(container);
    } else if (tab === 'sire') {
      this.renderSireTab(container);
    } else if (tab === 'kana') {
      this.renderKanaRows(container);
    }
  },

  renderSireTab(container) {
    state.sireNav = { level: 0, sire: null };
    container.innerHTML = "";
    const stats = {};
    state.masterData.forEach(h => {
      const s = h.sire ? h.sire.trim() : "不明";
      if(!stats[s]) stats[s] = { total: 0, checked: 0 };
      stats[s].total++;
      if (this.isSelected(h.id)) stats[s].checked++;
    });

    const grouped = new Map();
    const sires = Object.keys(stats).sort((a, b) => a.localeCompare(b, 'ja'));
    sires.forEach((sire) => {
      const head = this.getSireHeadLabel(sire);
      if (!grouped.has(head)) grouped.set(head, []);
      grouped.get(head).push(sire);
    });

    const orderedHeads = Array.from(grouped.keys()).sort((a, b) => this.compareSireHeadLabel(a, b));
    const list = document.createElement('div');
    list.className = 'cat-grid single-col sire-grid';
    orderedHeads.forEach((head) => {
      const entries = grouped.get(head);
      entries.forEach((sire, idx) => {
        const info = stats[sire];
        const btn = document.createElement('div');
        btn.className = 'cat-btn sire-cat-btn';

        const main = document.createElement('div');
        main.className = 'sire-item-main';
        main.innerHTML = `
          <span class="sire-head ${idx === 0 ? '' : 'empty'}">${head}</span>
          <span class="sire-name">${sire}</span>
          <span class="cat-count">${info.total}(${info.checked})</span>
        `;
        btn.appendChild(main);
        btn.onclick = () => {
          this.renderSireFinalList(container, sire);
        };

        const filterBtn = document.createElement('button');
        filterBtn.className = 'sire-filter-btn';
        filterBtn.title = '該当馬を全表示';
        filterBtn.innerHTML = '<i class="fa-solid fa-list"></i>';
        filterBtn.onclick = (e) => {
          e.stopPropagation();
          this.closeModal('searchModal');
          this.applyFilter('sire', sire);
        };
        btn.appendChild(filterBtn);

        list.appendChild(btn);
      });
    });
    container.appendChild(list);
  },

  renderSireFinalList(container, sire) {
    state.sireNav = { level: 1, sire };
    container.innerHTML = "";
    const backBtn = document.createElement('div');
    backBtn.className = 'back-btn';
    backBtn.innerHTML = '<i class="fa-solid fa-chevron-left"></i> 種牡馬一覧に戻る';
    backBtn.onclick = () => { this.renderSireTab(container); };
    container.appendChild(backBtn);

    const targetHorses = state.masterData
      .filter(h => (h.sire ? h.sire.trim() : "不明") === sire)
      .sort((a,b) => a.name.localeCompare(b.name, 'ja'));

    const ul = document.createElement('ul');
    ul.className = 'search-list';
    targetHorses.forEach(h => {
      const isChecked = this.isSelected(h.id);
      const li = document.createElement('li');
      li.className = 'search-item';
      li.innerHTML = `
        <div class="item-left">
          <div class="item-check ${isChecked ? 'checked' : ''}" id="chk_sire_${h.id}" onclick="app.toggleSelectionSireFinal('${h.id}', event)"></div>
          <div class="item-info">
            <div class="item-name">${h.name}</div>
            <div class="item-sub">${h.sire || ''}</div>
          </div>
        </div>
        <div class="item-jump ${isChecked ? '' : 'disabled'}" id="jmp_sire_${h.id}" onclick="app.jumpToHorse('${h.id}', event)">
          <i class="fa-solid fa-location-arrow"></i>
        </div>
      `;
      li.onclick = () => { this.showDetailById(h.id); };
      ul.appendChild(li);
    });
    if (targetHorses.length === 0) {
      ul.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">該当する馬がいません</div>';
    }
    container.appendChild(ul);
  },

  getSireHeadLabel(sireName) {
    const raw = (sireName || '').trim();
    if (!raw) return '他';
    const first = this.normalizeKana(raw.charAt(0));
    if (/[A-Za-z]/.test(first)) return 'A';
    if (/[0-9]/.test(first)) return '#';
    if (/[\u30A0-\u30FF]/.test(first)) return first;
    return '他';
  },

  normalizeKana(ch) {
    if (!ch) return '';
    let out = ch;
    const code = out.charCodeAt(0);
    if (code >= 0x3041 && code <= 0x3096) out = String.fromCharCode(code + 0x60);
    out = out.normalize('NFD').replace(/[\u3099\u309A]/g, '').normalize('NFC');
    const smallMap = {
      "ァ":"ア","ィ":"イ","ゥ":"ウ","ェ":"エ","ォ":"オ",
      "ャ":"ヤ","ュ":"ユ","ョ":"ヨ","ッ":"ツ","ヮ":"ワ","ヵ":"カ","ヶ":"ケ"
    };
    return smallMap[out] || out;
  },

  getNameInitial(name) {
    return this.normalizeKana((name || '').charAt(0));
  },

  compareSireHeadLabel(a, b) {
    if (a === 'A' && b !== 'A') return -1;
    if (a !== 'A' && b === 'A') return 1;
    if (a === '#' && b !== '#') return 1;
    if (a !== '#' && b === '#') return -1;
    if (a === '他' && b !== '他') return 1;
    if (a !== '他' && b === '他') return -1;
    return a.localeCompare(b, 'ja');
  },

  countKana(chars) {
    const charSet = new Set(chars.map((c) => this.normalizeKana(c)));
    return state.masterData.filter(h => charSet.has(this.getNameInitial(h.name))).length;
  },

  renderKanaRows(container) {
    state.kanaNav = { level: 0, rowKey: null, char: null };
    container.innerHTML = "";
    const grid = document.createElement('div');
    grid.className = 'cat-grid single-col';
    
    Object.keys(KANA_MAP).forEach(rowKey => {
      const chars = KANA_MAP[rowKey];
      const count = this.countKana(chars);
      if (count === 0) return;
      
      const btn = document.createElement('div');
      btn.className = 'cat-btn';
      btn.innerHTML = `<span>${rowKey}</span> <span class="cat-count">${count}</span>`;
      btn.onclick = () => {
        this.renderKanaSub(container, rowKey);
      };
      grid.appendChild(btn);
    });
    container.appendChild(grid);
  },

  renderKanaSub(container, rowKey) {
    state.kanaNav = { level: 1, rowKey, char: null };
    container.innerHTML = "";
    const backBtn = document.createElement('div');
    backBtn.className = 'back-btn';
    backBtn.innerHTML = '<i class="fa-solid fa-chevron-left"></i> 戻る';
    backBtn.onclick = () => { this.renderKanaRows(container); };
    container.appendChild(backBtn);
    
    const grid = document.createElement('div');
    grid.className = 'cat-grid single-col';
    
    const chars = KANA_MAP[rowKey];
    chars.forEach(char => {
        const count = this.countKana([char]);
        if (count === 0) return;
        const btn = document.createElement('div');
        btn.className = 'cat-btn';
        btn.innerHTML = `<span>${char}</span> <span class="cat-count">${count}</span>`;
        btn.onclick = () => {
          this.renderKanaFinalList(container, char, rowKey);
        };
        grid.appendChild(btn);
    });
    container.appendChild(grid);
  },

  renderKanaFinalList(container, char, rowKey) {
    state.kanaNav = { level: 2, rowKey, char };
    container.innerHTML = "";
    const backBtn = document.createElement('div');
    backBtn.className = 'back-btn';
    backBtn.innerHTML = `<i class="fa-solid fa-chevron-left"></i> ${rowKey}に戻る`;
    backBtn.onclick = () => { this.renderKanaSub(container, rowKey); };
    container.appendChild(backBtn);

    const targetHorses = state.masterData
      .filter(h => this.getNameInitial(h.name) === this.normalizeKana(char))
      .sort((a,b) => a.name.localeCompare(b.name, 'ja'));
    
    const ul = document.createElement('ul');
    ul.className = 'search-list';
    
    targetHorses.forEach(h => {
      const isChecked = this.isSelected(h.id);
      const li = document.createElement('li');
      li.className = 'search-item';
      li.innerHTML = `
        <div class="item-left">
          <div class="item-check ${isChecked ? 'checked' : ''}" id="chk_kana_${h.id}" onclick="app.toggleSelectionKanaFinal('${h.id}', event)"></div>
          <div class="item-info">
            <div class="item-name">${h.name}</div>
            <div class="item-sub">${h.sire || ''}</div>
          </div>
        </div>
        <div class="item-jump ${isChecked ? '' : 'disabled'}" id="jmp_kana_${h.id}" onclick="app.jumpToHorse('${h.id}', event)">
          <i class="fa-solid fa-location-arrow"></i>
        </div>
      `;
      li.onclick = () => { this.showDetailById(h.id); };
      ul.appendChild(li);
    });
    container.appendChild(ul);
  },

  renderAllTab(container) {
    const allCount = state.masterData.length;
    const checkedCount = state.masterData.filter((h) => this.isSelected(h.id)).length;
    const uncheckedCount = allCount - checkedCount;

    const ctrl = document.createElement('div');
    ctrl.className = 'control-bar';
    ctrl.innerHTML = `
      <div class="ctrl-row">
        <div class="ctrl-btn ${state.listFilter==='all'?'active':''}" onclick="app.setListFilter('all')" id="btn_filter_all">すべて (${allCount})</div>
        <div class="ctrl-btn ${state.listFilter==='checked'?'active':''}" onclick="app.setListFilter('checked')" id="btn_filter_checked">選択済 (${checkedCount})</div>
        <div class="ctrl-btn ${state.listFilter==='unchecked'?'active':''}" onclick="app.setListFilter('unchecked')" id="btn_filter_unchecked">未選択 (${uncheckedCount})</div>
      </div>
      <div class="ctrl-row">
        <div class="ctrl-btn ${state.listSort==='id'?'active':''}" onclick="app.setListSort('id')">ID順</div>
        <div class="ctrl-btn ${state.listSort==='name'?'active':''}" onclick="app.setListSort('name')">名前順</div>
        <div class="ctrl-btn ${state.listSort==='sire'?'active':''}" onclick="app.setListSort('sire')">種牡馬順</div>
      </div>
    `;
    container.appendChild(ctrl);

    const listContainer = document.createElement('div');
    listContainer.id = 'ledger-list';
    container.appendChild(listContainer);
    
    this.renderAllListItems(listContainer);
  },

  refreshAllTabFilterCounts() {
    const allBtn = document.getElementById('btn_filter_all');
    const checkedBtn = document.getElementById('btn_filter_checked');
    const uncheckedBtn = document.getElementById('btn_filter_unchecked');
    if (!allBtn || !checkedBtn || !uncheckedBtn) return;

    const allCount = state.masterData.length;
    const checkedCount = state.masterData.filter((h) => this.isSelected(h.id)).length;
    const uncheckedCount = allCount - checkedCount;

    allBtn.textContent = `すべて (${allCount})`;
    checkedBtn.textContent = `選択済 (${checkedCount})`;
    uncheckedBtn.textContent = `未選択 (${uncheckedCount})`;
  },

  setListFilter(val) {
    state.listFilter = val;
    this.switchTab('all'); 
  },
  
  setListSort(val) {
    state.listSort = val;
    this.switchTab('all'); 
  },

  renderAllListItems(container) {
    let list = [...state.masterData];

    if (state.listFilter === 'checked') {
      list = list.filter(h => this.isSelected(h.id));
    } else if (state.listFilter === 'unchecked') {
      list = list.filter(h => !this.isSelected(h.id));
    }

    if (state.listSort === 'name') {
      list.sort((a,b) => a.name.localeCompare(b.name, 'ja'));
    } else if (state.listSort === 'sire') {
      list.sort((a,b) => {
        const sa = a.sire || "";
        const sb = b.sire || "";
        return sa.localeCompare(sb, 'ja') || a.name.localeCompare(b.name, 'ja');
      });
    } else {
      list.sort((a,b) => String(a.id).localeCompare(String(b.id)));
    }

    const ul = document.createElement('ul');
    ul.className = 'search-list';
    list.forEach(h => {
      const isChecked = this.isSelected(h.id);
      const li = document.createElement('li');
      li.className = 'search-item';
      li.innerHTML = `
        <div class="item-left">
          <div class="item-check ${isChecked ? 'checked' : ''}" id="chk_all_${h.id}" onclick="app.toggleSelectionAllTab('${h.id}', event)"></div>
          <div class="item-info">
            <div class="item-name">${h.name}</div>
            <div class="item-sub">${h.sire}</div>
          </div>
        </div>
        <div class="item-jump ${isChecked ? '' : 'disabled'}" id="jmp_all_${h.id}" onclick="app.jumpToHorse('${h.id}', event)">
          <i class="fa-solid fa-location-arrow"></i>
        </div>
      `;
      li.onclick = () => { this.showDetailById(h.id); };
      ul.appendChild(li);
    });
    
    if (list.length === 0) {
      ul.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">該当する馬がいません</div>';
    }
    
    container.innerHTML = "";
    container.appendChild(ul);
  },

  toggleSelectionAllTab(id, e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    state.lastOp = {
      list: [...state.mySelectionIds],
      time: Date.now()
    };
    
    const idx = state.mySelectionIds.findIndex(sid => String(sid) === String(id));
    const el = document.getElementById(`chk_all_${id}`);
    const jumpEl = document.getElementById(`jmp_all_${id}`);
    
    if (idx >= 0) {
      if (!this.confirmRemoveFromMySelection(id)) return;
      state.mySelectionIds.splice(idx, 1);
      if(el) el.classList.remove('checked');
      if(jumpEl) jumpEl.classList.add('disabled');
    } else {
      if (!this.confirmAddToMySelection(id)) return;
      state.mySelectionIds.push(id);
      if(el) el.classList.add('checked');
      if(jumpEl) jumpEl.classList.remove('disabled');
    }
    this.saveUserState();
    this.refreshAllTabFilterCounts();
    this.showUndoToast();
  },

  toggleSelectionKanaFinal(id, e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    state.lastOp = {
      list: [...state.mySelectionIds],
      time: Date.now()
    };
    const idx = state.mySelectionIds.findIndex(sid => String(sid) === String(id));
    const el = document.getElementById(`chk_kana_${id}`);
    const jumpEl = document.getElementById(`jmp_kana_${id}`);

    if (idx >= 0) {
      if (!this.confirmRemoveFromMySelection(id)) return;
      state.mySelectionIds.splice(idx, 1);
      if (el) el.classList.remove('checked');
      if (jumpEl) jumpEl.classList.add('disabled');
    } else {
      if (!this.confirmAddToMySelection(id)) return;
      state.mySelectionIds.push(id);
      if (el) el.classList.add('checked');
      if (jumpEl) jumpEl.classList.remove('disabled');
    }
    this.saveUserState();
    this.showUndoToast();
  },

  toggleSelectionSireFinal(id, e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    state.lastOp = {
      list: [...state.mySelectionIds],
      time: Date.now()
    };
    const idx = state.mySelectionIds.findIndex(sid => String(sid) === String(id));
    const el = document.getElementById(`chk_sire_${id}`);
    const jumpEl = document.getElementById(`jmp_sire_${id}`);

    if (idx >= 0) {
      if (!this.confirmRemoveFromMySelection(id)) return;
      state.mySelectionIds.splice(idx, 1);
      if (el) el.classList.remove('checked');
      if (jumpEl) jumpEl.classList.add('disabled');
    } else {
      if (!this.confirmAddToMySelection(id)) return;
      state.mySelectionIds.push(id);
      if (el) el.classList.add('checked');
      if (jumpEl) jumpEl.classList.remove('disabled');
    }
    this.saveUserState();
    this.showUndoToast();
  },
  
  showUndoToast() {
    this.undoToast.classList.add('show');
    if (state.undoTimer) clearTimeout(state.undoTimer);
    state.undoTimer = setTimeout(() => {
      this.undoToast.classList.remove('show');
    }, 4000); 
  },
  
  execUndo() {
    if (!state.lastOp) return;
    state.mySelectionIds = [...state.lastOp.list];
    this.saveUserState();
    this.undoToast.classList.remove('show');
    this.switchTab('all');
    alert("元に戻しました");
  },
  
  toggleSelection(id) {
    const idx = state.mySelectionIds.findIndex(sid => String(sid) === String(id));
    if (idx >= 0) {
      if (!this.confirmRemoveFromMySelection(id)) return;
      state.mySelectionIds.splice(idx, 1);
    }
    else {
      if (!this.confirmAddToMySelection(id)) return;
      state.mySelectionIds.push(id);
    }
    this.saveUserState();
    this.switchTab(state.activeTab); 
  },
  
  confirmAddToMySelection(id) {
    const horse = state.masterData.find(h => String(h.id) === String(id));
    const label = horse ? horse.name : `ID:${id}`;
    return confirm(`「${label}」をマイ選抜に登録しますか？`);
  },

  confirmRemoveFromMySelection(id) {
    const horse = state.masterData.find(h => String(h.id) === String(id));
    const label = horse ? horse.name : `ID:${id}`;
    return confirm(`「${label}」をマイ選抜から解除しますか？`);
  },

  jumpToHorse(id, e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    if (!this.isSelected(id) && !this.confirmAddToMySelection(id)) return;

    this.closeModal('searchModal');
    
    if (state.viewMode !== 'my') {
      this.resetView(); 
    }
    
    if (!this.isSelected(id)) {
      state.mySelectionIds.push(id);
      this.saveUserState();
      this.updateRenderItems();
      this.render();
    } else {
      this.updateRenderItems();
      this.render();
    }
    
    setTimeout(() => {
      const target = document.querySelector(`.cell[data-horse-id="${id}"]`);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
             target.classList.add('highlight');
             setTimeout(() => target.classList.remove('highlight'), 3500);
        }, 800);
      } else {
        alert("表示できませんでした");
      }
    }, 100);
  },
  
  applyFilter(type, value) {
    state.viewMode = 'filter';
    state.filterType = type;
    state.filterValue = value;
    
    this.updateRenderItems();
    this.updateUIState();
    this.render();
    this.viewport.scrollTop = 0;
  },
  
  resetView() {
    state.viewMode = 'my';
    state.filterType = null;
    state.filterValue = null;
    this.updateRenderItems();
    this.updateUIState();
    this.render();
  },

  exportData() {
    this.closeModal('settingsModal');
    const data = { mySelectionIds: state.mySelectionIds, zoom: state.zoom };
    const str = JSON.stringify(data, null, 2);
    const blob = new Blob([str], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const now = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    const stamp = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}-${pad(now.getHours())}-${pad(now.getMinutes())}`;
    a.download = `selected_${stamp}.json`;
    a.click();
    URL.revokeObjectURL(url);
  },

  openImportPicker() {
    this.closeModal('settingsModal');
    document.getElementById('fileInput').click();
  },
  
  importData(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const json = JSON.parse(e.target.result);
        if (json.mySelectionIds) {
          state.mySelectionIds = json.mySelectionIds;
          state.zoom = json.zoom || 1.0;
          this.saveUserState();
          this.resetView(); 
          alert("設定を読み込みました");
        }
      } catch(err) { alert("データ形式が違います"); }
    };
    reader.readAsText(file);
    input.value = "";
  },
  
  resetData() {
    if(!confirm("登録状態をクリアして全馬を表示しますか？")) return;
    localStorage.removeItem(CONFIG.storageKey);
    location.reload();
  },

  attachEvents() {
    let pointerId = null;
    let startX=0, startY=0;
    let dragTimer = null;
    let isDragging = false;
    let isMultiTouch = false;
    let isMoving = false;
    let dragEl = null;     
    let ghostEl = null;    
    let currentIndex = -1;

    window.addEventListener("keydown", (e) => {
      if (e.target.tagName === 'INPUT') return;
      if (e.key === "+" || e.key === "=") { this.applyZoom(0.1); e.preventDefault(); }
      else if (e.key === "-") { this.applyZoom(-0.1); e.preventDefault(); }
      else if (e.key === "0") { state.zoom = 1.0; this.updateZoomStyle(); this.saveUserState(); e.preventDefault(); }
    });
    
    const triggerShowDetail = (el) => {
      app.showDetail(el);
    };

    const startDrag = (el, x, y) => {
      if (state.viewMode !== 'my') return;
      if (isMultiTouch || isMoving) return;

      isDragging = true;
      document.body.classList.add("is-dragging"); 
      
      dragEl = el;
      if (pointerId && dragEl.setPointerCapture) {
        try { dragEl.setPointerCapture(pointerId); } catch(e){}
      }
      
      dragEl.classList.add("is-placeholder");
      currentIndex = Number(dragEl.dataset.index);
      
      ghostEl = el.cloneNode(true);
      ghostEl.className = "ghost";
      ghostEl.classList.remove("is-placeholder", "pressed");
      const rect = el.getBoundingClientRect();
      ghostEl.style.width = rect.width + "px";
      ghostEl.style.height = rect.height + "px";
      document.body.appendChild(ghostEl);
      updateGhost(x, y);
      
      if (navigator.vibrate) navigator.vibrate(50);
    };

    const updateGhost = (x, y) => {
      if (ghostEl) {
        ghostEl.style.left = x + "px";
        ghostEl.style.top = y + "px";
      }
    };

    this.board.addEventListener("pointerdown", (e) => {
      if (e.button !== 0) return;
      if (isMultiTouch) return;
      
      if (e.target.closest('.mini-check')) return;

      const cell = e.target.closest(".cell");
      if (!cell || cell.dataset.type !== 'card') return; 

      pointerId = e.pointerId;
      startX = e.clientX; startY = e.clientY;
      isMoving = false;
      cell.classList.add("pressed");

      dragTimer = setTimeout(() => {
        if (!isMoving) startDrag(cell, e.clientX, e.clientY);
      }, CONFIG.longPressDelay);
    });

    this.board.addEventListener("pointermove", (e) => {
      if (e.pointerId !== pointerId) return;

      if (isDragging) {
        e.preventDefault(); 
        updateGhost(e.clientX, e.clientY);
        handleSwapLogic(e.clientX, e.clientY);
        return;
      }

      const dx = Math.abs(e.clientX - startX);
      const dy = Math.abs(e.clientY - startY);
      if (dx > CONFIG.moveThreshold || dy > CONFIG.moveThreshold) { 
        isMoving = true;
        if (dragTimer) clearTimeout(dragTimer);
        const cell = e.target.closest(".cell");
        if (cell) cell.classList.remove("pressed");
      }
    });

    this.viewport.addEventListener("touchmove", (e) => {
      if (isDragging) e.preventDefault();
    }, { passive: false });

    const handleSwapLogic = (x, y) => {
      if (ghostEl) ghostEl.style.display = 'none';
      let target = document.elementFromPoint(x, y);
      if (ghostEl) ghostEl.style.display = 'block';

      if (!target) return;
      const targetCell = target.closest('.cell');
      
      if (targetCell && targetCell !== dragEl && this.board.contains(targetCell) && targetCell.dataset.type === 'card') {
        const targetIndex = Number(targetCell.dataset.index);
        
        const fromId = dragEl.dataset.horseId;
        const toId = targetCell.dataset.horseId;
        
        const fromIdxState = state.mySelectionIds.findIndex((sid) => String(sid) === String(fromId));
        const toIdxState = state.mySelectionIds.findIndex((sid) => String(sid) === String(toId));
        
        if (fromIdxState >= 0 && toIdxState >= 0) {
            const temp = state.mySelectionIds[fromIdxState];
            state.mySelectionIds[fromIdxState] = state.mySelectionIds[toIdxState];
            state.mySelectionIds[toIdxState] = temp;
            
            const tempItem = state.renderItems[currentIndex];
            state.renderItems[currentIndex] = state.renderItems[targetIndex];
            state.renderItems[targetIndex] = tempItem;

            const dragHtml = dragEl.innerHTML;
            const dragIdAttr = dragEl.dataset.horseId;
            
            dragEl.innerHTML = targetCell.innerHTML;
            dragEl.dataset.horseId = targetCell.dataset.horseId;
            dragEl.classList.remove("is-placeholder"); 

            targetCell.innerHTML = dragHtml;
            targetCell.dataset.horseId = dragIdAttr;
            targetCell.classList.add("is-placeholder");

            dragEl = targetCell;
            currentIndex = targetIndex;
            if(pointerId) { try{ dragEl.setPointerCapture(pointerId); }catch(e){} }
        }
      }
    };

    const endInteraction = (e) => {
      if (pointerId && e.pointerId !== pointerId) return;
      if (dragTimer) clearTimeout(dragTimer);

      const cell = e.target.closest(".cell");
      
      if (isDragging) {
        isDragging = false;
        document.body.classList.remove("is-dragging");
        if (ghostEl) ghostEl.remove();
        if (dragEl) dragEl.classList.remove("is-placeholder");
        if (cell) cell.classList.remove("pressed");
        this.saveUserState(); 
      } else {
        if (!isMoving && cell && cell.dataset.type === 'card') {
          cell.classList.remove("pressed");
          triggerShowDetail(cell);
        }
      }
      pointerId = null;
    };

    this.board.addEventListener("pointerup", endInteraction);
    this.board.addEventListener("pointercancel", endInteraction);

    ["detailModal", "settingsModal"].forEach((id) => {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.addEventListener("click", (e) => {
        if (e.target === modal) this.closeModal(id);
      });
    });
    const searchModal = document.getElementById("searchModal");
    if (searchModal) {
      searchModal.addEventListener("click", (e) => {
        if (e.target === searchModal) this.handleSearchModalBackdropTap();
      });
    }
    
    let initialDist = 0;
    let initialZoom = 1.0;
    this.viewport.addEventListener("touchstart", (e) => {
      if (e.touches.length >= 2) {
        isMultiTouch = true;
        if (isDragging) endInteraction(e); 
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        initialDist = Math.hypot(dx, dy);
        initialZoom = state.zoom;
        e.preventDefault(); 
      }
    }, { passive: false });

    this.viewport.addEventListener("touchmove", (e) => {
      if (isMultiTouch && e.touches.length >= 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const dist = Math.hypot(dx, dy);
        if (initialDist > 0) {
           const ratio = dist / initialDist;
           const newZoom = Math.min(Math.max(initialZoom * ratio, CONFIG.minZoom), CONFIG.maxZoom);
           state.zoom = newZoom;
           this.updateZoomStyle();
        }
      }
    }, { passive: false });

    this.viewport.addEventListener("touchend", (e) => {
      if (e.touches.length < 2) {
        isMultiTouch = false;
        this.saveUserState();
      }
    });
    
    this.viewport.addEventListener("wheel", (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        const delta = e.deltaY * -0.01;
        this.applyZoom(delta);
      }
    }, { passive: false });
  },

  applyZoom(delta) {
    let newZoom = state.zoom + delta;
    newZoom = Math.min(Math.max(newZoom, CONFIG.minZoom), CONFIG.maxZoom);
    state.zoom = newZoom;
    this.updateZoomStyle();
    if (this.zoomTimer) clearTimeout(this.zoomTimer);
    this.zoomTimer = setTimeout(()=> this.saveUserState(), 500);
  }
};

app.init();
</script>
</body>
</html>
